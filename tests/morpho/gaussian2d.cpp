#include <mln/core/algorithm/all_of.hpp>
#include <mln/core/image/ndimage.hpp>
#include <mln/core/image/view/operators.hpp>
#include <mln/core/neighborhood/c4.hpp>
#include <mln/io/imread.hpp>
#include <mln/io/imsave.hpp>
#include <mln/morpho/experimental/fill_hole.hpp>
#include <mln/morpho/experimental/gaussian_directional_2d.hpp>

#include <fixtures/ImageCompare/image_compare.hpp>
#include <fixtures/ImagePath/image_path.hpp>

#include <gtest/gtest.h>


TEST(Morpho, gaussian2d)
{

  mln::image2d<uint8_t> tiny_lena = {
      {159, 148, 104, 115, 129, 131, 129, 128, 128, 122, 138, 156, 164, 154, 119, 90}, //
      {156, 144, 101, 113, 126, 129, 138, 151, 138, 119, 130, 152, 149, 167, 96, 50},  //
      {123, 140, 98, 110, 120, 122, 141, 178, 190, 139, 125, 129, 139, 118, 57, 74},   //
      {106, 139, 97, 112, 116, 124, 146, 181, 200, 193, 146, 114, 148, 75, 68, 137},   //
      {111, 143, 97, 118, 122, 127, 154, 172, 180, 187, 182, 183, 178, 71, 117, 157},  //
      {114, 146, 97, 123, 140, 129, 130, 120, 126, 171, 188, 174, 113, 83, 152, 155},  //
      {114, 146, 97, 115, 141, 110, 77, 75, 138, 183, 158, 106, 61, 116, 161, 155},    //
      {110, 146, 100, 114, 113, 70, 63, 126, 147, 176, 149, 75, 69, 144, 155, 148},    //
      {103, 147, 105, 108, 83, 64, 95, 141, 127, 152, 109, 74, 95, 152, 149, 156},     //
      {88, 145, 108, 89, 69, 81, 102, 134, 157, 154, 122, 78, 121, 149, 161, 196},     //
      {89, 148, 100, 82, 92, 97, 75, 124, 143, 148, 93, 83, 143, 146, 182, 210},       //
      {84, 151, 92, 83, 114, 77, 57, 98, 137, 130, 63, 92, 146, 144, 194, 199},        //
      {96, 147, 82, 75, 103, 76, 53, 87, 138, 160, 122, 98, 132, 134, 176, 113},       //
      {113, 146, 73, 59, 87, 91, 64, 105, 138, 164, 192, 135, 137, 162, 147, 95},      //
      {114, 148, 72, 54, 76, 70, 77, 121, 139, 150, 188, 164, 111, 153, 110, 89},      //
      {126, 149, 68, 64, 74, 65, 98, 131, 141, 145, 173, 177, 106, 112, 88, 82},       //
  };

  mln::image2d<uint8_t> tiny_lena_blurred = {
      {202, 183, 166, 156, 150, 148, 148, 147, 147, 145, 143, 141, 139, 142, 153, 172}, //
      {182, 163, 149, 141, 139, 140, 143, 146, 147, 146, 143, 139, 136, 135, 140, 155}, //
      {167, 150, 137, 131, 131, 135, 141, 146, 149, 148, 145, 140, 134, 131, 134, 146}, //
      {156, 140, 130, 126, 127, 132, 139, 145, 150, 150, 146, 140, 133, 129, 132, 142}, //
      {148, 135, 126, 122, 123, 127, 134, 142, 148, 149, 146, 139, 133, 130, 133, 142}, //
      {142, 130, 123, 119, 119, 122, 128, 136, 142, 145, 142, 136, 131, 130, 135, 144}, //
      {137, 127, 119, 115, 113, 115, 120, 128, 135, 138, 136, 132, 129, 131, 137, 146}, //
      {132, 123, 115, 110, 107, 108, 113, 121, 128, 131, 130, 127, 128, 133, 140, 148}, //
      {127, 119, 112, 106, 102, 103, 108, 116, 123, 126, 126, 125, 128, 135, 144, 151}, //
      {122, 115, 108, 102, 98, 99, 105, 113, 120, 123, 123, 124, 129, 138, 147, 153},   //
      {118, 112, 105, 98, 95, 96, 101, 110, 117, 122, 123, 126, 131, 140, 148, 153},    //
      {116, 110, 103, 96, 92, 93, 99, 108, 117, 123, 126, 129, 134, 140, 147, 150},     //
      {115, 109, 102, 96, 92, 93, 99, 109, 119, 126, 130, 132, 135, 139, 142, 144},     //
      {118, 113, 106, 99, 94, 95, 102, 112, 122, 130, 135, 136, 136, 136, 136, 136},    //
      {126, 123, 116, 108, 103, 103, 107, 116, 126, 134, 138, 138, 135, 132, 130, 128}, //
      {139, 139, 133, 124, 118, 115, 117, 123, 130, 136, 139, 138, 134, 130, 125, 123}, //
  };


  constexpr int kLineVerticalSigma   = 2.;
  constexpr int kLineHorizontalSigma = 2.;
  auto          ret = mln::morpho::experimental::gaussian2d(tiny_lena, kLineVerticalSigma, kLineHorizontalSigma, 255);

  ASSERT_IMAGES_EQ_EXP(tiny_lena_blurred, ret);
}
